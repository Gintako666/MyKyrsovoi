import e from"fs";import t from"deep-diff";import n from"object-hash";
/*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT */function r(e){return null==e}var i=function(e,t){var n,r="";for(n=0;n<t;n+=1)r+=e;return r},o={isNothing:r,isObject:function(e){return"object"==typeof e&&null!==e},toArray:function(e){return Array.isArray(e)?e:r(e)?[]:[e]},repeat:i,isNegativeZero:function(e){return 0===e&&Number.NEGATIVE_INFINITY===1/e},extend:function(e,t){var n,r,i,o;if(t)for(n=0,r=(o=Object.keys(t)).length;n<r;n+=1)e[i=o[n]]=t[i];return e}};function a(e,t){var n="",r=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(n+='in "'+e.mark.name+'" '),n+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(n+="\n\n"+e.mark.snippet),r+" "+n):r}function c(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=a(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack||""}c.prototype=Object.create(Error.prototype),c.prototype.constructor=c,c.prototype.toString=function(e){return this.name+": "+a(this,e)};var l=c;function s(e,t,n,r,i){var o="",a="",c=Math.floor(i/2)-1;return r-t>c&&(t=r-c+(o=" ... ").length),n-r>c&&(n=r+c-(a=" ...").length),{str:o+e.slice(t,n).replace(/\t/g,"â†’")+a,pos:r-t+o.length}}function u(e,t){return o.repeat(" ",t-e.length)+e}var p=function(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),"number"!=typeof t.indent&&(t.indent=1),"number"!=typeof t.linesBefore&&(t.linesBefore=3),"number"!=typeof t.linesAfter&&(t.linesAfter=2);for(var n,r=/\r?\n|\r|\0/g,i=[0],a=[],c=-1;n=r.exec(e.buffer);)a.push(n.index),i.push(n.index+n[0].length),e.position<=n.index&&c<0&&(c=i.length-2);c<0&&(c=i.length-1);var l,p,f="",d=Math.min(e.line+t.linesAfter,a.length).toString().length,h=t.maxLength-(t.indent+d+3);for(l=1;l<=t.linesBefore&&!(c-l<0);l++)p=s(e.buffer,i[c-l],a[c-l],e.position-(i[c]-i[c-l]),h),f=o.repeat(" ",t.indent)+u((e.line-l+1).toString(),d)+" | "+p.str+"\n"+f;for(p=s(e.buffer,i[c],a[c],e.position,h),f+=o.repeat(" ",t.indent)+u((e.line+1).toString(),d)+" | "+p.str+"\n",f+=o.repeat("-",t.indent+d+3+p.pos)+"^\n",l=1;l<=t.linesAfter&&!(c+l>=a.length);l++)p=s(e.buffer,i[c+l],a[c+l],e.position-(i[c]-i[c+l]),h),f+=o.repeat(" ",t.indent)+u((e.line+l+1).toString(),d)+" | "+p.str+"\n";return f.replace(/\n$/,"")},f=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],d=["scalar","sequence","mapping"];var h=function(e,t){if(t=t||{},Object.keys(t).forEach((function(t){if(-1===f.indexOf(t))throw new l('Unknown option "'+t+'" is met in definition of "'+e+'" YAML type.')})),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(e){return e},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=function(e){var t={};return null!==e&&Object.keys(e).forEach((function(n){e[n].forEach((function(e){t[String(e)]=n}))})),t}(t.styleAliases||null),-1===d.indexOf(this.kind))throw new l('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')};function g(e,t){var n=[];return e[t].forEach((function(e){var t=n.length;n.forEach((function(n,r){n.tag===e.tag&&n.kind===e.kind&&n.multi===e.multi&&(t=r)})),n[t]=e})),n}function m(e){return this.extend(e)}m.prototype.extend=function(e){var t=[],n=[];if(e instanceof h)n.push(e);else if(Array.isArray(e))n=n.concat(e);else{if(!e||!Array.isArray(e.implicit)&&!Array.isArray(e.explicit))throw new l("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(n=n.concat(e.explicit))}t.forEach((function(e){if(!(e instanceof h))throw new l("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(e.loadKind&&"scalar"!==e.loadKind)throw new l("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(e.multi)throw new l("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),n.forEach((function(e){if(!(e instanceof h))throw new l("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var r=Object.create(m.prototype);return r.implicit=(this.implicit||[]).concat(t),r.explicit=(this.explicit||[]).concat(n),r.compiledImplicit=g(r,"implicit"),r.compiledExplicit=g(r,"explicit"),r.compiledTypeMap=function(){var e,t,n={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function r(e){e.multi?(n.multi[e.kind].push(e),n.multi.fallback.push(e)):n[e.kind][e.tag]=n.fallback[e.tag]=e}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(r);return n}(r.compiledImplicit,r.compiledExplicit),r};var y=new m({explicit:[new h("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return null!==e?e:""}}),new h("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return null!==e?e:[]}}),new h("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return null!==e?e:{}}})]});var v=new h("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(e){if(null===e)return!0;var t=e.length;return 1===t&&"~"===e||4===t&&("null"===e||"Null"===e||"NULL"===e)},construct:function(){return null},predicate:function(e){return null===e},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});var b=new h("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t=e.length;return 4===t&&("true"===e||"True"===e||"TRUE"===e)||5===t&&("false"===e||"False"===e||"FALSE"===e)},construct:function(e){return"true"===e||"True"===e||"TRUE"===e},predicate:function(e){return"[object Boolean]"===Object.prototype.toString.call(e)},represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function w(e){return 48<=e&&e<=55}function A(e){return 48<=e&&e<=57}var _=new h("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,n,r=e.length,i=0,o=!1;if(!r)return!1;if("-"!==(t=e[i])&&"+"!==t||(t=e[++i]),"0"===t){if(i+1===r)return!0;if("b"===(t=e[++i])){for(i++;i<r;i++)if("_"!==(t=e[i])){if("0"!==t&&"1"!==t)return!1;o=!0}return o&&"_"!==t}if("x"===t){for(i++;i<r;i++)if("_"!==(t=e[i])){if(!(48<=(n=e.charCodeAt(i))&&n<=57||65<=n&&n<=70||97<=n&&n<=102))return!1;o=!0}return o&&"_"!==t}if("o"===t){for(i++;i<r;i++)if("_"!==(t=e[i])){if(!w(e.charCodeAt(i)))return!1;o=!0}return o&&"_"!==t}}if("_"===t)return!1;for(;i<r;i++)if("_"!==(t=e[i])){if(!A(e.charCodeAt(i)))return!1;o=!0}return!(!o||"_"===t)},construct:function(e){var t,n=e,r=1;if(-1!==n.indexOf("_")&&(n=n.replace(/_/g,"")),"-"!==(t=n[0])&&"+"!==t||("-"===t&&(r=-1),t=(n=n.slice(1))[0]),"0"===n)return 0;if("0"===t){if("b"===n[1])return r*parseInt(n.slice(2),2);if("x"===n[1])return r*parseInt(n.slice(2),16);if("o"===n[1])return r*parseInt(n.slice(2),8)}return r*parseInt(n,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&e%1==0&&!o.isNegativeZero(e)},represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),j=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");var k=/^[-+]?[0-9]+e/;var x=new h("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(e){return null!==e&&!(!j.test(e)||"_"===e[e.length-1])},construct:function(e){var t,n;return n="-"===(t=e.replace(/_/g,"").toLowerCase())[0]?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),".inf"===t?1===n?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:".nan"===t?NaN:n*parseFloat(t,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&(e%1!=0||o.isNegativeZero(e))},represent:function(e,t){var n;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(o.isNegativeZero(e))return"-0.0";return n=e.toString(10),k.test(n)?n.replace("e",".e"):n},defaultStyle:"lowercase"}),O=y.extend({implicit:[v,b,_,x]}),S=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),C=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");var I=new h("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(e){return null!==e&&(null!==S.exec(e)||null!==C.exec(e))},construct:function(e){var t,n,r,i,o,a,c,l,s=0,u=null;if(null===(t=S.exec(e))&&(t=C.exec(e)),null===t)throw new Error("Date resolve error");if(n=+t[1],r=+t[2]-1,i=+t[3],!t[4])return new Date(Date.UTC(n,r,i));if(o=+t[4],a=+t[5],c=+t[6],t[7]){for(s=t[7].slice(0,3);s.length<3;)s+="0";s=+s}return t[9]&&(u=6e4*(60*+t[10]+ +(t[11]||0)),"-"===t[9]&&(u=-u)),l=new Date(Date.UTC(n,r,i,o,a,c,s)),u&&l.setTime(l.getTime()-u),l},instanceOf:Date,represent:function(e){return e.toISOString()}});var T=new h("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(e){return"<<"===e||null===e}}),F="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\n\r";var N=new h("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,n,r=0,i=e.length,o=F;for(n=0;n<i;n++)if(!((t=o.indexOf(e.charAt(n)))>64)){if(t<0)return!1;r+=6}return r%8==0},construct:function(e){var t,n,r=e.replace(/[\r\n=]/g,""),i=r.length,o=F,a=0,c=[];for(t=0;t<i;t++)t%4==0&&t&&(c.push(a>>16&255),c.push(a>>8&255),c.push(255&a)),a=a<<6|o.indexOf(r.charAt(t));return 0===(n=i%4*6)?(c.push(a>>16&255),c.push(a>>8&255),c.push(255&a)):18===n?(c.push(a>>10&255),c.push(a>>2&255)):12===n&&c.push(a>>4&255),new Uint8Array(c)},predicate:function(e){return"[object Uint8Array]"===Object.prototype.toString.call(e)},represent:function(e){var t,n,r="",i=0,o=e.length,a=F;for(t=0;t<o;t++)t%3==0&&t&&(r+=a[i>>18&63],r+=a[i>>12&63],r+=a[i>>6&63],r+=a[63&i]),i=(i<<8)+e[t];return 0===(n=o%3)?(r+=a[i>>18&63],r+=a[i>>12&63],r+=a[i>>6&63],r+=a[63&i]):2===n?(r+=a[i>>10&63],r+=a[i>>4&63],r+=a[i<<2&63],r+=a[64]):1===n&&(r+=a[i>>2&63],r+=a[i<<4&63],r+=a[64],r+=a[64]),r}}),E=Object.prototype.hasOwnProperty,M=Object.prototype.toString;var L=new h("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,n,r,i,o,a=[],c=e;for(t=0,n=c.length;t<n;t+=1){if(r=c[t],o=!1,"[object Object]"!==M.call(r))return!1;for(i in r)if(E.call(r,i)){if(o)return!1;o=!0}if(!o)return!1;if(-1!==a.indexOf(i))return!1;a.push(i)}return!0},construct:function(e){return null!==e?e:[]}}),D=Object.prototype.toString;var z=new h("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,n,r,i,o,a=e;for(o=new Array(a.length),t=0,n=a.length;t<n;t+=1){if(r=a[t],"[object Object]"!==D.call(r))return!1;if(1!==(i=Object.keys(r)).length)return!1;o[t]=[i[0],r[i[0]]]}return!0},construct:function(e){if(null===e)return[];var t,n,r,i,o,a=e;for(o=new Array(a.length),t=0,n=a.length;t<n;t+=1)r=a[t],i=Object.keys(r),o[t]=[i[0],r[i[0]]];return o}}),P=Object.prototype.hasOwnProperty;var q=new h("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(e){if(null===e)return!0;var t,n=e;for(t in n)if(P.call(n,t)&&null!==n[t])return!1;return!0},construct:function(e){return null!==e?e:{}}}),U=O.extend({implicit:[I,T],explicit:[N,L,z,q]}),$=Object.prototype.hasOwnProperty,B=1,Y=2,R=3,W=4,K=1,V=2,G=3,H=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Q=/[\x85\u2028\u2029]/,Z=/[,\[\]\{\}]/,J=/^(?:!|!!|![a-z\-]+!)$/i,X=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function ee(e){return Object.prototype.toString.call(e)}function te(e){return 10===e||13===e}function ne(e){return 9===e||32===e}function re(e){return 9===e||32===e||10===e||13===e}function ie(e){return 44===e||91===e||93===e||123===e||125===e}function oe(e){var t;return 48<=e&&e<=57?e-48:97<=(t=32|e)&&t<=102?t-97+10:-1}function ae(e){return 48===e?"\0":97===e?"":98===e?"\b":116===e||9===e?"\t":110===e?"\n":118===e?"\v":102===e?"\f":114===e?"\r":101===e?"":32===e?" ":34===e?'"':47===e?"/":92===e?"\\":78===e?"Â…":95===e?"Â ":76===e?"\u2028":80===e?"\u2029":""}function ce(e){return e<=65535?String.fromCharCode(e):String.fromCharCode(55296+(e-65536>>10),56320+(e-65536&1023))}for(var le=new Array(256),se=new Array(256),ue=0;ue<256;ue++)le[ue]=ae(ue)?1:0,se[ue]=ae(ue);function pe(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||U,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function fe(e,t){var n={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return n.snippet=p(n),new l(t,n)}function de(e,t){throw fe(e,t)}function he(e,t){e.onWarning&&e.onWarning.call(null,fe(e,t))}var ge={YAML:function(e,t,n){var r,i,o;null!==e.version&&de(e,"duplication of %YAML directive"),1!==n.length&&de(e,"YAML directive accepts exactly one argument"),null===(r=/^([0-9]+)\.([0-9]+)$/.exec(n[0]))&&de(e,"ill-formed argument of the YAML directive"),i=parseInt(r[1],10),o=parseInt(r[2],10),1!==i&&de(e,"unacceptable YAML version of the document"),e.version=n[0],e.checkLineBreaks=o<2,1!==o&&2!==o&&he(e,"unsupported YAML version of the document")},TAG:function(e,t,n){var r,i;2!==n.length&&de(e,"TAG directive accepts exactly two arguments"),r=n[0],i=n[1],J.test(r)||de(e,"ill-formed tag handle (first argument) of the TAG directive"),$.call(e.tagMap,r)&&de(e,'there is a previously declared suffix for "'+r+'" tag handle'),X.test(i)||de(e,"ill-formed tag prefix (second argument) of the TAG directive");try{i=decodeURIComponent(i)}catch(t){de(e,"tag prefix is malformed: "+i)}e.tagMap[r]=i}};function me(e,t,n,r){var i,o,a,c;if(t<n){if(c=e.input.slice(t,n),r)for(i=0,o=c.length;i<o;i+=1)9===(a=c.charCodeAt(i))||32<=a&&a<=1114111||de(e,"expected valid JSON character");else H.test(c)&&de(e,"the stream contains non-printable characters");e.result+=c}}function ye(e,t,n,r){var i,a,c,l;for(o.isObject(n)||de(e,"cannot merge mappings; the provided source object is unacceptable"),c=0,l=(i=Object.keys(n)).length;c<l;c+=1)a=i[c],$.call(t,a)||(t[a]=n[a],r[a]=!0)}function ve(e,t,n,r,i,o,a,c,l){var s,u;if(Array.isArray(i))for(s=0,u=(i=Array.prototype.slice.call(i)).length;s<u;s+=1)Array.isArray(i[s])&&de(e,"nested arrays are not supported inside keys"),"object"==typeof i&&"[object Object]"===ee(i[s])&&(i[s]="[object Object]");if("object"==typeof i&&"[object Object]"===ee(i)&&(i="[object Object]"),i=String(i),null===t&&(t={}),"tag:yaml.org,2002:merge"===r)if(Array.isArray(o))for(s=0,u=o.length;s<u;s+=1)ye(e,t,o[s],n);else ye(e,t,o,n);else e.json||$.call(n,i)||!$.call(t,i)||(e.line=a||e.line,e.lineStart=c||e.lineStart,e.position=l||e.position,de(e,"duplicated mapping key")),"__proto__"===i?Object.defineProperty(t,i,{configurable:!0,enumerable:!0,writable:!0,value:o}):t[i]=o,delete n[i];return t}function be(e){var t;10===(t=e.input.charCodeAt(e.position))?e.position++:13===t?(e.position++,10===e.input.charCodeAt(e.position)&&e.position++):de(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function we(e,t,n){for(var r=0,i=e.input.charCodeAt(e.position);0!==i;){for(;ne(i);)9===i&&-1===e.firstTabInLine&&(e.firstTabInLine=e.position),i=e.input.charCodeAt(++e.position);if(t&&35===i)do{i=e.input.charCodeAt(++e.position)}while(10!==i&&13!==i&&0!==i);if(!te(i))break;for(be(e),i=e.input.charCodeAt(e.position),r++,e.lineIndent=0;32===i;)e.lineIndent++,i=e.input.charCodeAt(++e.position)}return-1!==n&&0!==r&&e.lineIndent<n&&he(e,"deficient indentation"),r}function Ae(e){var t,n=e.position;return!(45!==(t=e.input.charCodeAt(n))&&46!==t||t!==e.input.charCodeAt(n+1)||t!==e.input.charCodeAt(n+2)||(n+=3,0!==(t=e.input.charCodeAt(n))&&!re(t)))}function _e(e,t){1===t?e.result+=" ":t>1&&(e.result+=o.repeat("\n",t-1))}function je(e,t){var n,r,i=e.tag,o=e.anchor,a=[],c=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=a),r=e.input.charCodeAt(e.position);0!==r&&(-1!==e.firstTabInLine&&(e.position=e.firstTabInLine,de(e,"tab characters must not be used in indentation")),45===r)&&re(e.input.charCodeAt(e.position+1));)if(c=!0,e.position++,we(e,!0,-1)&&e.lineIndent<=t)a.push(null),r=e.input.charCodeAt(e.position);else if(n=e.line,Oe(e,t,R,!1,!0),a.push(e.result),we(e,!0,-1),r=e.input.charCodeAt(e.position),(e.line===n||e.lineIndent>t)&&0!==r)de(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break;return!!c&&(e.tag=i,e.anchor=o,e.kind="sequence",e.result=a,!0)}function ke(e){var t,n,r,i,o=!1,a=!1;if(33!==(i=e.input.charCodeAt(e.position)))return!1;if(null!==e.tag&&de(e,"duplication of a tag property"),60===(i=e.input.charCodeAt(++e.position))?(o=!0,i=e.input.charCodeAt(++e.position)):33===i?(a=!0,n="!!",i=e.input.charCodeAt(++e.position)):n="!",t=e.position,o){do{i=e.input.charCodeAt(++e.position)}while(0!==i&&62!==i);e.position<e.length?(r=e.input.slice(t,e.position),i=e.input.charCodeAt(++e.position)):de(e,"unexpected end of the stream within a verbatim tag")}else{for(;0!==i&&!re(i);)33===i&&(a?de(e,"tag suffix cannot contain exclamation marks"):(n=e.input.slice(t-1,e.position+1),J.test(n)||de(e,"named tag handle cannot contain such characters"),a=!0,t=e.position+1)),i=e.input.charCodeAt(++e.position);r=e.input.slice(t,e.position),Z.test(r)&&de(e,"tag suffix cannot contain flow indicator characters")}r&&!X.test(r)&&de(e,"tag name cannot contain such characters: "+r);try{r=decodeURIComponent(r)}catch(t){de(e,"tag name is malformed: "+r)}return o?e.tag=r:$.call(e.tagMap,n)?e.tag=e.tagMap[n]+r:"!"===n?e.tag="!"+r:"!!"===n?e.tag="tag:yaml.org,2002:"+r:de(e,'undeclared tag handle "'+n+'"'),!0}function xe(e){var t,n;if(38!==(n=e.input.charCodeAt(e.position)))return!1;for(null!==e.anchor&&de(e,"duplication of an anchor property"),n=e.input.charCodeAt(++e.position),t=e.position;0!==n&&!re(n)&&!ie(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&de(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function Oe(e,t,n,r,i){var a,c,l,s,u,p,f,d,h,g=1,m=!1,y=!1;if(null!==e.listener&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,a=c=l=W===n||R===n,r&&we(e,!0,-1)&&(m=!0,e.lineIndent>t?g=1:e.lineIndent===t?g=0:e.lineIndent<t&&(g=-1)),1===g)for(;ke(e)||xe(e);)we(e,!0,-1)?(m=!0,l=a,e.lineIndent>t?g=1:e.lineIndent===t?g=0:e.lineIndent<t&&(g=-1)):l=!1;if(l&&(l=m||i),1!==g&&W!==n||(d=B===n||Y===n?t:t+1,h=e.position-e.lineStart,1===g?l&&(je(e,h)||function(e,t,n){var r,i,o,a,c,l,s,u=e.tag,p=e.anchor,f={},d=Object.create(null),h=null,g=null,m=null,y=!1,v=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=f),s=e.input.charCodeAt(e.position);0!==s;){if(y||-1===e.firstTabInLine||(e.position=e.firstTabInLine,de(e,"tab characters must not be used in indentation")),r=e.input.charCodeAt(e.position+1),o=e.line,63!==s&&58!==s||!re(r)){if(a=e.line,c=e.lineStart,l=e.position,!Oe(e,n,Y,!1,!0))break;if(e.line===o){for(s=e.input.charCodeAt(e.position);ne(s);)s=e.input.charCodeAt(++e.position);if(58===s)re(s=e.input.charCodeAt(++e.position))||de(e,"a whitespace character is expected after the key-value separator within a block mapping"),y&&(ve(e,f,d,h,g,null,a,c,l),h=g=m=null),v=!0,y=!1,i=!1,h=e.tag,g=e.result;else{if(!v)return e.tag=u,e.anchor=p,!0;de(e,"can not read an implicit mapping pair; a colon is missed")}}else{if(!v)return e.tag=u,e.anchor=p,!0;de(e,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else 63===s?(y&&(ve(e,f,d,h,g,null,a,c,l),h=g=m=null),v=!0,y=!0,i=!0):y?(y=!1,i=!0):de(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,s=r;if((e.line===o||e.lineIndent>t)&&(y&&(a=e.line,c=e.lineStart,l=e.position),Oe(e,t,W,!0,i)&&(y?g=e.result:m=e.result),y||(ve(e,f,d,h,g,m,a,c,l),h=g=m=null),we(e,!0,-1),s=e.input.charCodeAt(e.position)),(e.line===o||e.lineIndent>t)&&0!==s)de(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return y&&ve(e,f,d,h,g,null,a,c,l),v&&(e.tag=u,e.anchor=p,e.kind="mapping",e.result=f),v}(e,h,d))||function(e,t){var n,r,i,o,a,c,l,s,u,p,f,d,h=!0,g=e.tag,m=e.anchor,y=Object.create(null);if(91===(d=e.input.charCodeAt(e.position)))a=93,s=!1,o=[];else{if(123!==d)return!1;a=125,s=!0,o={}}for(null!==e.anchor&&(e.anchorMap[e.anchor]=o),d=e.input.charCodeAt(++e.position);0!==d;){if(we(e,!0,t),(d=e.input.charCodeAt(e.position))===a)return e.position++,e.tag=g,e.anchor=m,e.kind=s?"mapping":"sequence",e.result=o,!0;h?44===d&&de(e,"expected the node content, but found ','"):de(e,"missed comma between flow collection entries"),f=null,c=l=!1,63===d&&re(e.input.charCodeAt(e.position+1))&&(c=l=!0,e.position++,we(e,!0,t)),n=e.line,r=e.lineStart,i=e.position,Oe(e,t,B,!1,!0),p=e.tag,u=e.result,we(e,!0,t),d=e.input.charCodeAt(e.position),!l&&e.line!==n||58!==d||(c=!0,d=e.input.charCodeAt(++e.position),we(e,!0,t),Oe(e,t,B,!1,!0),f=e.result),s?ve(e,o,y,p,u,f,n,r,i):c?o.push(ve(e,null,y,p,u,f,n,r,i)):o.push(u),we(e,!0,t),44===(d=e.input.charCodeAt(e.position))?(h=!0,d=e.input.charCodeAt(++e.position)):h=!1}de(e,"unexpected end of the stream within a flow collection")}(e,d)?y=!0:(c&&function(e,t){var n,r,i,a,c,l=K,s=!1,u=!1,p=t,f=0,d=!1;if(124===(a=e.input.charCodeAt(e.position)))r=!1;else{if(62!==a)return!1;r=!0}for(e.kind="scalar",e.result="";0!==a;)if(43===(a=e.input.charCodeAt(++e.position))||45===a)K===l?l=43===a?G:V:de(e,"repeat of a chomping mode identifier");else{if(!((i=48<=(c=a)&&c<=57?c-48:-1)>=0))break;0===i?de(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):u?de(e,"repeat of an indentation width identifier"):(p=t+i-1,u=!0)}if(ne(a)){do{a=e.input.charCodeAt(++e.position)}while(ne(a));if(35===a)do{a=e.input.charCodeAt(++e.position)}while(!te(a)&&0!==a)}for(;0!==a;){for(be(e),e.lineIndent=0,a=e.input.charCodeAt(e.position);(!u||e.lineIndent<p)&&32===a;)e.lineIndent++,a=e.input.charCodeAt(++e.position);if(!u&&e.lineIndent>p&&(p=e.lineIndent),te(a))f++;else{if(e.lineIndent<p){l===G?e.result+=o.repeat("\n",s?1+f:f):l===K&&s&&(e.result+="\n");break}for(r?ne(a)?(d=!0,e.result+=o.repeat("\n",s?1+f:f)):d?(d=!1,e.result+=o.repeat("\n",f+1)):0===f?s&&(e.result+=" "):e.result+=o.repeat("\n",f):e.result+=o.repeat("\n",s?1+f:f),s=!0,u=!0,f=0,n=e.position;!te(a)&&0!==a;)a=e.input.charCodeAt(++e.position);me(e,n,e.position,!1)}}return!0}(e,d)||function(e,t){var n,r,i;if(39!==(n=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,r=i=e.position;0!==(n=e.input.charCodeAt(e.position));)if(39===n){if(me(e,r,e.position,!0),39!==(n=e.input.charCodeAt(++e.position)))return!0;r=e.position,e.position++,i=e.position}else te(n)?(me(e,r,i,!0),_e(e,we(e,!1,t)),r=i=e.position):e.position===e.lineStart&&Ae(e)?de(e,"unexpected end of the document within a single quoted scalar"):(e.position++,i=e.position);de(e,"unexpected end of the stream within a single quoted scalar")}(e,d)||function(e,t){var n,r,i,o,a,c,l;if(34!==(c=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,n=r=e.position;0!==(c=e.input.charCodeAt(e.position));){if(34===c)return me(e,n,e.position,!0),e.position++,!0;if(92===c){if(me(e,n,e.position,!0),te(c=e.input.charCodeAt(++e.position)))we(e,!1,t);else if(c<256&&le[c])e.result+=se[c],e.position++;else if((a=120===(l=c)?2:117===l?4:85===l?8:0)>0){for(i=a,o=0;i>0;i--)(a=oe(c=e.input.charCodeAt(++e.position)))>=0?o=(o<<4)+a:de(e,"expected hexadecimal character");e.result+=ce(o),e.position++}else de(e,"unknown escape sequence");n=r=e.position}else te(c)?(me(e,n,r,!0),_e(e,we(e,!1,t)),n=r=e.position):e.position===e.lineStart&&Ae(e)?de(e,"unexpected end of the document within a double quoted scalar"):(e.position++,r=e.position)}de(e,"unexpected end of the stream within a double quoted scalar")}(e,d)?y=!0:!function(e){var t,n,r;if(42!==(r=e.input.charCodeAt(e.position)))return!1;for(r=e.input.charCodeAt(++e.position),t=e.position;0!==r&&!re(r)&&!ie(r);)r=e.input.charCodeAt(++e.position);return e.position===t&&de(e,"name of an alias node must contain at least one character"),n=e.input.slice(t,e.position),$.call(e.anchorMap,n)||de(e,'unidentified alias "'+n+'"'),e.result=e.anchorMap[n],we(e,!0,-1),!0}(e)?function(e,t,n){var r,i,o,a,c,l,s,u,p=e.kind,f=e.result;if(re(u=e.input.charCodeAt(e.position))||ie(u)||35===u||38===u||42===u||33===u||124===u||62===u||39===u||34===u||37===u||64===u||96===u)return!1;if((63===u||45===u)&&(re(r=e.input.charCodeAt(e.position+1))||n&&ie(r)))return!1;for(e.kind="scalar",e.result="",i=o=e.position,a=!1;0!==u;){if(58===u){if(re(r=e.input.charCodeAt(e.position+1))||n&&ie(r))break}else if(35===u){if(re(e.input.charCodeAt(e.position-1)))break}else{if(e.position===e.lineStart&&Ae(e)||n&&ie(u))break;if(te(u)){if(c=e.line,l=e.lineStart,s=e.lineIndent,we(e,!1,-1),e.lineIndent>=t){a=!0,u=e.input.charCodeAt(e.position);continue}e.position=o,e.line=c,e.lineStart=l,e.lineIndent=s;break}}a&&(me(e,i,o,!1),_e(e,e.line-c),i=o=e.position,a=!1),ne(u)||(o=e.position+1),u=e.input.charCodeAt(++e.position)}return me(e,i,o,!1),!!e.result||(e.kind=p,e.result=f,!1)}(e,d,B===n)&&(y=!0,null===e.tag&&(e.tag="?")):(y=!0,null===e.tag&&null===e.anchor||de(e,"alias node should not have any properties")),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):0===g&&(y=l&&je(e,h))),null===e.tag)null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);else if("?"===e.tag){for(null!==e.result&&"scalar"!==e.kind&&de(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),s=0,u=e.implicitTypes.length;s<u;s+=1)if((f=e.implicitTypes[s]).resolve(e.result)){e.result=f.construct(e.result),e.tag=f.tag,null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);break}}else if("!"!==e.tag){if($.call(e.typeMap[e.kind||"fallback"],e.tag))f=e.typeMap[e.kind||"fallback"][e.tag];else for(f=null,s=0,u=(p=e.typeMap.multi[e.kind||"fallback"]).length;s<u;s+=1)if(e.tag.slice(0,p[s].tag.length)===p[s].tag){f=p[s];break}f||de(e,"unknown tag !<"+e.tag+">"),null!==e.result&&f.kind!==e.kind&&de(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+f.kind+'", not "'+e.kind+'"'),f.resolve(e.result,e.tag)?(e.result=f.construct(e.result,e.tag),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):de(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return null!==e.listener&&e.listener("close",e),null!==e.tag||null!==e.anchor||y}function Se(e){var t,n,r,i,o=e.position,a=!1;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);0!==(i=e.input.charCodeAt(e.position))&&(we(e,!0,-1),i=e.input.charCodeAt(e.position),!(e.lineIndent>0||37!==i));){for(a=!0,i=e.input.charCodeAt(++e.position),t=e.position;0!==i&&!re(i);)i=e.input.charCodeAt(++e.position);for(r=[],(n=e.input.slice(t,e.position)).length<1&&de(e,"directive name must not be less than one character in length");0!==i;){for(;ne(i);)i=e.input.charCodeAt(++e.position);if(35===i){do{i=e.input.charCodeAt(++e.position)}while(0!==i&&!te(i));break}if(te(i))break;for(t=e.position;0!==i&&!re(i);)i=e.input.charCodeAt(++e.position);r.push(e.input.slice(t,e.position))}0!==i&&be(e),$.call(ge,n)?ge[n](e,n,r):he(e,'unknown document directive "'+n+'"')}we(e,!0,-1),0===e.lineIndent&&45===e.input.charCodeAt(e.position)&&45===e.input.charCodeAt(e.position+1)&&45===e.input.charCodeAt(e.position+2)?(e.position+=3,we(e,!0,-1)):a&&de(e,"directives end mark is expected"),Oe(e,e.lineIndent-1,W,!1,!0),we(e,!0,-1),e.checkLineBreaks&&Q.test(e.input.slice(o,e.position))&&he(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&Ae(e)?46===e.input.charCodeAt(e.position)&&(e.position+=3,we(e,!0,-1)):e.position<e.length-1&&de(e,"end of the stream or a document separator is expected")}function Ce(e,t){t=t||{},0!==(e=String(e)).length&&(10!==e.charCodeAt(e.length-1)&&13!==e.charCodeAt(e.length-1)&&(e+="\n"),65279===e.charCodeAt(0)&&(e=e.slice(1)));var n=new pe(e,t),r=e.indexOf("\0");for(-1!==r&&(n.position=r,de(n,"null byte is not allowed in input")),n.input+="\0";32===n.input.charCodeAt(n.position);)n.lineIndent+=1,n.position+=1;for(;n.position<n.length-1;)Se(n);return n.documents}var Ie={loadAll:function(e,t,n){null!==t&&"object"==typeof t&&void 0===n&&(n=t,t=null);var r=Ce(e,n);if("function"!=typeof t)return r;for(var i=0,o=r.length;i<o;i+=1)t(r[i])},load:function(e,t){var n=Ce(e,t);if(0!==n.length){if(1===n.length)return n[0];throw new l("expected a single document in the stream, but found more")}}},Te=Object.prototype.toString,Fe=Object.prototype.hasOwnProperty,Ne=65279,Ee=9,Me=10,Le=13,De=32,ze=33,Pe=34,qe=35,Ue=37,$e=38,Be=39,Ye=42,Re=44,We=45,Ke=58,Ve=61,Ge=62,He=63,Qe=64,Ze=91,Je=93,Xe=96,et=123,tt=124,nt=125,rt={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},it=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],ot=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function at(e){var t,n,r;if(t=e.toString(16).toUpperCase(),e<=255)n="x",r=2;else if(e<=65535)n="u",r=4;else{if(!(e<=4294967295))throw new l("code point within a string may not be greater than 0xFFFFFFFF");n="U",r=8}return"\\"+n+o.repeat("0",r-t.length)+t}var ct=1,lt=2;function st(e){this.schema=e.schema||U,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=o.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=function(e,t){var n,r,i,o,a,c,l;if(null===t)return{};for(n={},i=0,o=(r=Object.keys(t)).length;i<o;i+=1)a=r[i],c=String(t[a]),"!!"===a.slice(0,2)&&(a="tag:yaml.org,2002:"+a.slice(2)),(l=e.compiledTypeMap.fallback[a])&&Fe.call(l.styleAliases,c)&&(c=l.styleAliases[c]),n[a]=c;return n}(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType='"'===e.quotingType?lt:ct,this.forceQuotes=e.forceQuotes||!1,this.replacer="function"==typeof e.replacer?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function ut(e,t){for(var n,r=o.repeat(" ",t),i=0,a=-1,c="",l=e.length;i<l;)-1===(a=e.indexOf("\n",i))?(n=e.slice(i),i=l):(n=e.slice(i,a+1),i=a+1),n.length&&"\n"!==n&&(c+=r),c+=n;return c}function pt(e,t){return"\n"+o.repeat(" ",e.indent*t)}function ft(e){return e===De||e===Ee}function dt(e){return 32<=e&&e<=126||161<=e&&e<=55295&&8232!==e&&8233!==e||57344<=e&&e<=65533&&e!==Ne||65536<=e&&e<=1114111}function ht(e){return dt(e)&&e!==Ne&&e!==Le&&e!==Me}function gt(e,t,n){var r=ht(e),i=r&&!ft(e);return(n?r:r&&e!==Re&&e!==Ze&&e!==Je&&e!==et&&e!==nt)&&e!==qe&&!(t===Ke&&!i)||ht(t)&&!ft(t)&&e===qe||t===Ke&&i}function mt(e,t){var n,r=e.charCodeAt(t);return r>=55296&&r<=56319&&t+1<e.length&&(n=e.charCodeAt(t+1))>=56320&&n<=57343?1024*(r-55296)+n-56320+65536:r}function yt(e){return/^\n* /.test(e)}var vt=1,bt=2,wt=3,At=4,_t=5;function jt(e,t,n,r,i,o,a,c){var l,s,u=0,p=null,f=!1,d=!1,h=-1!==r,g=-1,m=dt(s=mt(e,0))&&s!==Ne&&!ft(s)&&s!==We&&s!==He&&s!==Ke&&s!==Re&&s!==Ze&&s!==Je&&s!==et&&s!==nt&&s!==qe&&s!==$e&&s!==Ye&&s!==ze&&s!==tt&&s!==Ve&&s!==Ge&&s!==Be&&s!==Pe&&s!==Ue&&s!==Qe&&s!==Xe&&function(e){return!ft(e)&&e!==Ke}(mt(e,e.length-1));if(t||a)for(l=0;l<e.length;u>=65536?l+=2:l++){if(!dt(u=mt(e,l)))return _t;m=m&&gt(u,p,c),p=u}else{for(l=0;l<e.length;u>=65536?l+=2:l++){if((u=mt(e,l))===Me)f=!0,h&&(d=d||l-g-1>r&&" "!==e[g+1],g=l);else if(!dt(u))return _t;m=m&&gt(u,p,c),p=u}d=d||h&&l-g-1>r&&" "!==e[g+1]}return f||d?n>9&&yt(e)?_t:a?o===lt?_t:bt:d?At:wt:!m||a||i(e)?o===lt?_t:bt:vt}function kt(e,t,n,r,i){e.dump=function(){if(0===t.length)return e.quotingType===lt?'""':"''";if(!e.noCompatMode&&(-1!==it.indexOf(t)||ot.test(t)))return e.quotingType===lt?'"'+t+'"':"'"+t+"'";var o=e.indent*Math.max(1,n),a=-1===e.lineWidth?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-o),c=r||e.flowLevel>-1&&n>=e.flowLevel;switch(jt(t,c,e.indent,a,(function(t){return function(e,t){var n,r;for(n=0,r=e.implicitTypes.length;n<r;n+=1)if(e.implicitTypes[n].resolve(t))return!0;return!1}(e,t)}),e.quotingType,e.forceQuotes&&!r,i)){case vt:return t;case bt:return"'"+t.replace(/'/g,"''")+"'";case wt:return"|"+xt(t,e.indent)+Ot(ut(t,o));case At:return">"+xt(t,e.indent)+Ot(ut(function(e,t){var n,r,i=/(\n+)([^\n]*)/g,o=(c=e.indexOf("\n"),c=-1!==c?c:e.length,i.lastIndex=c,St(e.slice(0,c),t)),a="\n"===e[0]||" "===e[0];var c;for(;r=i.exec(e);){var l=r[1],s=r[2];n=" "===s[0],o+=l+(a||n||""===s?"":"\n")+St(s,t),a=n}return o}(t,a),o));case _t:return'"'+function(e){for(var t,n="",r=0,i=0;i<e.length;r>=65536?i+=2:i++)r=mt(e,i),!(t=rt[r])&&dt(r)?(n+=e[i],r>=65536&&(n+=e[i+1])):n+=t||at(r);return n}(t)+'"';default:throw new l("impossible error: invalid scalar style")}}()}function xt(e,t){var n=yt(e)?String(t):"",r="\n"===e[e.length-1];return n+(r&&("\n"===e[e.length-2]||"\n"===e)?"+":r?"":"-")+"\n"}function Ot(e){return"\n"===e[e.length-1]?e.slice(0,-1):e}function St(e,t){if(""===e||" "===e[0])return e;for(var n,r,i=/ [^ ]/g,o=0,a=0,c=0,l="";n=i.exec(e);)(c=n.index)-o>t&&(r=a>o?a:c,l+="\n"+e.slice(o,r),o=r+1),a=c;return l+="\n",e.length-o>t&&a>o?l+=e.slice(o,a)+"\n"+e.slice(a+1):l+=e.slice(o),l.slice(1)}function Ct(e,t,n,r){var i,o,a,c="",l=e.tag;for(i=0,o=n.length;i<o;i+=1)a=n[i],e.replacer&&(a=e.replacer.call(n,String(i),a)),(Tt(e,t+1,a,!0,!0,!1,!0)||void 0===a&&Tt(e,t+1,null,!0,!0,!1,!0))&&(r&&""===c||(c+=pt(e,t)),e.dump&&Me===e.dump.charCodeAt(0)?c+="-":c+="- ",c+=e.dump);e.tag=l,e.dump=c||"[]"}function It(e,t,n){var r,i,o,a,c,s;for(o=0,a=(i=n?e.explicitTypes:e.implicitTypes).length;o<a;o+=1)if(((c=i[o]).instanceOf||c.predicate)&&(!c.instanceOf||"object"==typeof t&&t instanceof c.instanceOf)&&(!c.predicate||c.predicate(t))){if(n?c.multi&&c.representName?e.tag=c.representName(t):e.tag=c.tag:e.tag="?",c.represent){if(s=e.styleMap[c.tag]||c.defaultStyle,"[object Function]"===Te.call(c.represent))r=c.represent(t,s);else{if(!Fe.call(c.represent,s))throw new l("!<"+c.tag+'> tag resolver accepts not "'+s+'" style');r=c.represent[s](t,s)}e.dump=r}return!0}return!1}function Tt(e,t,n,r,i,o,a){e.tag=null,e.dump=n,It(e,n,!1)||It(e,n,!0);var c,s=Te.call(e.dump),u=r;r&&(r=e.flowLevel<0||e.flowLevel>t);var p,f,d="[object Object]"===s||"[object Array]"===s;if(d&&(f=-1!==(p=e.duplicates.indexOf(n))),(null!==e.tag&&"?"!==e.tag||f||2!==e.indent&&t>0)&&(i=!1),f&&e.usedDuplicates[p])e.dump="*ref_"+p;else{if(d&&f&&!e.usedDuplicates[p]&&(e.usedDuplicates[p]=!0),"[object Object]"===s)r&&0!==Object.keys(e.dump).length?(!function(e,t,n,r){var i,o,a,c,s,u,p="",f=e.tag,d=Object.keys(n);if(!0===e.sortKeys)d.sort();else if("function"==typeof e.sortKeys)d.sort(e.sortKeys);else if(e.sortKeys)throw new l("sortKeys must be a boolean or a function");for(i=0,o=d.length;i<o;i+=1)u="",r&&""===p||(u+=pt(e,t)),c=n[a=d[i]],e.replacer&&(c=e.replacer.call(n,a,c)),Tt(e,t+1,a,!0,!0,!0)&&((s=null!==e.tag&&"?"!==e.tag||e.dump&&e.dump.length>1024)&&(e.dump&&Me===e.dump.charCodeAt(0)?u+="?":u+="? "),u+=e.dump,s&&(u+=pt(e,t)),Tt(e,t+1,c,!0,s)&&(e.dump&&Me===e.dump.charCodeAt(0)?u+=":":u+=": ",p+=u+=e.dump));e.tag=f,e.dump=p||"{}"}(e,t,e.dump,i),f&&(e.dump="&ref_"+p+e.dump)):(!function(e,t,n){var r,i,o,a,c,l="",s=e.tag,u=Object.keys(n);for(r=0,i=u.length;r<i;r+=1)c="",""!==l&&(c+=", "),e.condenseFlow&&(c+='"'),a=n[o=u[r]],e.replacer&&(a=e.replacer.call(n,o,a)),Tt(e,t,o,!1,!1)&&(e.dump.length>1024&&(c+="? "),c+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),Tt(e,t,a,!1,!1)&&(l+=c+=e.dump));e.tag=s,e.dump="{"+l+"}"}(e,t,e.dump),f&&(e.dump="&ref_"+p+" "+e.dump));else if("[object Array]"===s)r&&0!==e.dump.length?(e.noArrayIndent&&!a&&t>0?Ct(e,t-1,e.dump,i):Ct(e,t,e.dump,i),f&&(e.dump="&ref_"+p+e.dump)):(!function(e,t,n){var r,i,o,a="",c=e.tag;for(r=0,i=n.length;r<i;r+=1)o=n[r],e.replacer&&(o=e.replacer.call(n,String(r),o)),(Tt(e,t,o,!1,!1)||void 0===o&&Tt(e,t,null,!1,!1))&&(""!==a&&(a+=","+(e.condenseFlow?"":" ")),a+=e.dump);e.tag=c,e.dump="["+a+"]"}(e,t,e.dump),f&&(e.dump="&ref_"+p+" "+e.dump));else{if("[object String]"!==s){if("[object Undefined]"===s)return!1;if(e.skipInvalid)return!1;throw new l("unacceptable kind of an object to dump "+s)}"?"!==e.tag&&kt(e,e.dump,t,o,u)}null!==e.tag&&"?"!==e.tag&&(c=encodeURI("!"===e.tag[0]?e.tag.slice(1):e.tag).replace(/!/g,"%21"),c="!"===e.tag[0]?"!"+c:"tag:yaml.org,2002:"===c.slice(0,18)?"!!"+c.slice(18):"!<"+c+">",e.dump=c+" "+e.dump)}return!0}function Ft(e,t){var n,r,i=[],o=[];for(Nt(e,i,o),n=0,r=o.length;n<r;n+=1)t.duplicates.push(i[o[n]]);t.usedDuplicates=new Array(r)}function Nt(e,t,n){var r,i,o;if(null!==e&&"object"==typeof e)if(-1!==(i=t.indexOf(e)))-1===n.indexOf(i)&&n.push(i);else if(t.push(e),Array.isArray(e))for(i=0,o=e.length;i<o;i+=1)Nt(e[i],t,n);else for(i=0,o=(r=Object.keys(e)).length;i<o;i+=1)Nt(e[r[i]],t,n)}var Et=Ie.load,Mt={dump:function(e,t){var n=new st(t=t||{});n.noRefs||Ft(e,n);var r=e;return n.replacer&&(r=n.replacer.call({"":r},"",r)),Tt(n,0,r,!0,!0)?n.dump+"\n":""}}.dump;const Lt=["directus_collections","directus_relations","directus_fields","directus_activity","directus_revisions"],Dt=async({schema:e,services:t,database:n})=>{const{CollectionsService:r,ItemsService:i}=t,o=new r({schema:e}),a=await o.readByQuery({limit:-1}),c={};for(let t=0;t<a.length;t+=1){const r=a[t],i=e.collections[r.collection]?.primary;if(Lt.includes(r.collection)||!r.meta||!i)continue;const o=await n(r.collection).select().then((e=>e.reduce(((e,t)=>(e[t[i]]=JSON.parse(JSON.stringify(t)),e)),{})));c[r.collection]=o}return c},zt=async(e,{services:r,schema:i,database:o,force:a})=>{const{SchemaService:c}=r,l=new c({accountability:{admin:!0}}),s=await l.snapshot(),u=await Dt({services:r,schema:i,database:o}),p={...e};delete p.data,delete p.seeds;const f=await l.diff(p,{currentSnapshot:s,force:a}),d={};for(let n in e.data){let r=t.diff(e.data[n],u[n]||{});r&&(d[n]=r)}return{diff:{collections:f?.collections||[],relations:f?.relations||[],fields:f?.fields||[],data:d},hash:(h=s,n({item:h,version:"12.1.2"}))};var h};var Pt="object"==typeof global&&global&&global.Object===Object&&global,qt="object"==typeof self&&self&&self.Object===Object&&self,Ut=Pt||qt||Function("return this")(),$t=Ut.Symbol,Bt=Object.prototype,Yt=Bt.hasOwnProperty,Rt=Bt.toString,Wt=$t?$t.toStringTag:void 0;var Kt=Object.prototype.toString;var Vt="[object Null]",Gt="[object Undefined]",Ht=$t?$t.toStringTag:void 0;function Qt(e){return null==e?void 0===e?Gt:Vt:Ht&&Ht in Object(e)?function(e){var t=Yt.call(e,Wt),n=e[Wt];try{e[Wt]=void 0;var r=!0}catch(e){}var i=Rt.call(e);return r&&(t?e[Wt]=n:delete e[Wt]),i}(e):function(e){return Kt.call(e)}(e)}function Zt(e){return null!=e&&"object"==typeof e}function Jt(e,t){for(var n=-1,r=null==e?0:e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i}var Xt=Array.isArray;function en(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function tn(e){return e}var nn="[object AsyncFunction]",rn="[object Function]",on="[object GeneratorFunction]",an="[object Proxy]";function cn(e){if(!en(e))return!1;var t=Qt(e);return t==rn||t==on||t==nn||t==an}var ln,sn=Ut["__core-js_shared__"],un=(ln=/[^.]+$/.exec(sn&&sn.keys&&sn.keys.IE_PROTO||""))?"Symbol(src)_1."+ln:"";var pn=Function.prototype.toString;function fn(e){if(null!=e){try{return pn.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var dn=/^\[object .+?Constructor\]$/,hn=Function.prototype,gn=Object.prototype,mn=hn.toString,yn=gn.hasOwnProperty,vn=RegExp("^"+mn.call(yn).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function bn(e){return!(!en(e)||(t=e,un&&un in t))&&(cn(e)?vn:dn).test(fn(e));var t}function wn(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return bn(n)?n:void 0}var An=wn(Ut,"WeakMap");var _n=Date.now;var jn,kn,xn,On=function(){try{var e=wn(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),Sn=On?function(e,t){return On(e,"toString",{configurable:!0,enumerable:!1,value:(n=t,function(){return n}),writable:!0});var n}:tn,Cn=(jn=Sn,kn=0,xn=0,function(){var e=_n(),t=16-(e-xn);if(xn=e,t>0){if(++kn>=800)return arguments[0]}else kn=0;return jn.apply(void 0,arguments)});function In(e){return e!=e}function Tn(e,t){return!!(null==e?0:e.length)&&function(e,t,n){return t==t?function(e,t,n){for(var r=n-1,i=e.length;++r<i;)if(e[r]===t)return r;return-1}(e,t,n):function(e,t,n,r){for(var i=e.length,o=n+(r?1:-1);r?o--:++o<i;)if(t(e[o],o,e))return o;return-1}(e,In,n)}(e,t,0)>-1}var Fn=9007199254740991,Nn=/^(?:0|[1-9]\d*)$/;function En(e,t){var n=typeof e;return!!(t=null==t?Fn:t)&&("number"==n||"symbol"!=n&&Nn.test(e))&&e>-1&&e%1==0&&e<t}function Mn(e,t){return e===t||e!=e&&t!=t}var Ln=Math.max;var Dn=9007199254740991;function zn(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=Dn}function Pn(e){return null!=e&&zn(e.length)&&!cn(e)}var qn=Object.prototype;function Un(e){return Zt(e)&&"[object Arguments]"==Qt(e)}var $n=Object.prototype,Bn=$n.hasOwnProperty,Yn=$n.propertyIsEnumerable,Rn=Un(function(){return arguments}())?Un:function(e){return Zt(e)&&Bn.call(e,"callee")&&!Yn.call(e,"callee")};var Wn="object"==typeof exports&&exports&&!exports.nodeType&&exports,Kn=Wn&&"object"==typeof module&&module&&!module.nodeType&&module,Vn=Kn&&Kn.exports===Wn?Ut.Buffer:void 0,Gn=(Vn?Vn.isBuffer:void 0)||function(){return!1},Hn={};function Qn(e){return function(t){return e(t)}}Hn["[object Float32Array]"]=Hn["[object Float64Array]"]=Hn["[object Int8Array]"]=Hn["[object Int16Array]"]=Hn["[object Int32Array]"]=Hn["[object Uint8Array]"]=Hn["[object Uint8ClampedArray]"]=Hn["[object Uint16Array]"]=Hn["[object Uint32Array]"]=!0,Hn["[object Arguments]"]=Hn["[object Array]"]=Hn["[object ArrayBuffer]"]=Hn["[object Boolean]"]=Hn["[object DataView]"]=Hn["[object Date]"]=Hn["[object Error]"]=Hn["[object Function]"]=Hn["[object Map]"]=Hn["[object Number]"]=Hn["[object Object]"]=Hn["[object RegExp]"]=Hn["[object Set]"]=Hn["[object String]"]=Hn["[object WeakMap]"]=!1;var Zn="object"==typeof exports&&exports&&!exports.nodeType&&exports,Jn=Zn&&"object"==typeof module&&module&&!module.nodeType&&module,Xn=Jn&&Jn.exports===Zn&&Pt.process,er=function(){try{var e=Jn&&Jn.require&&Jn.require("util").types;return e||Xn&&Xn.binding&&Xn.binding("util")}catch(e){}}(),tr=er&&er.isTypedArray,nr=tr?Qn(tr):function(e){return Zt(e)&&zn(e.length)&&!!Hn[Qt(e)]},rr=Object.prototype.hasOwnProperty;function ir(e,t){var n=Xt(e),r=!n&&Rn(e),i=!n&&!r&&Gn(e),o=!n&&!r&&!i&&nr(e),a=n||r||i||o,c=a?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],l=c.length;for(var s in e)!t&&!rr.call(e,s)||a&&("length"==s||i&&("offset"==s||"parent"==s)||o&&("buffer"==s||"byteLength"==s||"byteOffset"==s)||En(s,l))||c.push(s);return c}var or=function(e,t){return function(n){return e(t(n))}}(Object.keys,Object),ar=Object.prototype.hasOwnProperty;function cr(e){if(n=(t=e)&&t.constructor,t!==("function"==typeof n&&n.prototype||qn))return or(e);var t,n,r=[];for(var i in Object(e))ar.call(e,i)&&"constructor"!=i&&r.push(i);return r}function lr(e){return Pn(e)?ir(e):cr(e)}var sr=wn(Object,"create");var ur=Object.prototype.hasOwnProperty;var pr=Object.prototype.hasOwnProperty;function fr(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function dr(e,t){for(var n=e.length;n--;)if(Mn(e[n][0],t))return n;return-1}fr.prototype.clear=function(){this.__data__=sr?sr(null):{},this.size=0},fr.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},fr.prototype.get=function(e){var t=this.__data__;if(sr){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return ur.call(t,e)?t[e]:void 0},fr.prototype.has=function(e){var t=this.__data__;return sr?void 0!==t[e]:pr.call(t,e)},fr.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=sr&&void 0===t?"__lodash_hash_undefined__":t,this};var hr=Array.prototype.splice;function gr(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}gr.prototype.clear=function(){this.__data__=[],this.size=0},gr.prototype.delete=function(e){var t=this.__data__,n=dr(t,e);return!(n<0)&&(n==t.length-1?t.pop():hr.call(t,n,1),--this.size,!0)},gr.prototype.get=function(e){var t=this.__data__,n=dr(t,e);return n<0?void 0:t[n][1]},gr.prototype.has=function(e){return dr(this.__data__,e)>-1},gr.prototype.set=function(e,t){var n=this.__data__,r=dr(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this};var mr=wn(Ut,"Map");function yr(e,t){var n=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?n["string"==typeof t?"string":"hash"]:n.map}function vr(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}vr.prototype.clear=function(){this.size=0,this.__data__={hash:new fr,map:new(mr||gr),string:new fr}},vr.prototype.delete=function(e){var t=yr(this,e).delete(e);return this.size-=t?1:0,t},vr.prototype.get=function(e){return yr(this,e).get(e)},vr.prototype.has=function(e){return yr(this,e).has(e)},vr.prototype.set=function(e,t){var n=yr(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this};function br(e){var t=this.__data__=new gr(e);this.size=t.size}br.prototype.clear=function(){this.__data__=new gr,this.size=0},br.prototype.delete=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n},br.prototype.get=function(e){return this.__data__.get(e)},br.prototype.has=function(e){return this.__data__.has(e)},br.prototype.set=function(e,t){var n=this.__data__;if(n instanceof gr){var r=n.__data__;if(!mr||r.length<199)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new vr(r)}return n.set(e,t),this.size=n.size,this};var wr=Object.prototype.propertyIsEnumerable,Ar=Object.getOwnPropertySymbols,_r=Ar?function(e){return null==e?[]:(e=Object(e),function(e,t){for(var n=-1,r=null==e?0:e.length,i=0,o=[];++n<r;){var a=e[n];t(a,n,e)&&(o[i++]=a)}return o}(Ar(e),(function(t){return wr.call(e,t)})))}:function(){return[]};function jr(e){return function(e,t,n){var r=t(e);return Xt(e)?r:function(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}(r,n(e))}(e,lr,_r)}var kr=wn(Ut,"DataView"),xr=wn(Ut,"Promise"),Or=wn(Ut,"Set"),Sr="[object Map]",Cr="[object Promise]",Ir="[object Set]",Tr="[object WeakMap]",Fr="[object DataView]",Nr=fn(kr),Er=fn(mr),Mr=fn(xr),Lr=fn(Or),Dr=fn(An),zr=Qt;(kr&&zr(new kr(new ArrayBuffer(1)))!=Fr||mr&&zr(new mr)!=Sr||xr&&zr(xr.resolve())!=Cr||Or&&zr(new Or)!=Ir||An&&zr(new An)!=Tr)&&(zr=function(e){var t=Qt(e),n="[object Object]"==t?e.constructor:void 0,r=n?fn(n):"";if(r)switch(r){case Nr:return Fr;case Er:return Sr;case Mr:return Cr;case Lr:return Ir;case Dr:return Tr}return t});var Pr=zr,qr=Ut.Uint8Array;function Ur(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new vr;++t<n;)this.add(e[t])}function $r(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}function Br(e,t){return e.has(t)}Ur.prototype.add=Ur.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},Ur.prototype.has=function(e){return this.__data__.has(e)};var Yr=1,Rr=2;function Wr(e,t,n,r,i,o){var a=n&Yr,c=e.length,l=t.length;if(c!=l&&!(a&&l>c))return!1;var s=o.get(e),u=o.get(t);if(s&&u)return s==t&&u==e;var p=-1,f=!0,d=n&Rr?new Ur:void 0;for(o.set(e,t),o.set(t,e);++p<c;){var h=e[p],g=t[p];if(r)var m=a?r(g,h,p,t,e,o):r(h,g,p,e,t,o);if(void 0!==m){if(m)continue;f=!1;break}if(d){if(!$r(t,(function(e,t){if(!Br(d,t)&&(h===e||i(h,e,n,r,o)))return d.push(t)}))){f=!1;break}}else if(h!==g&&!i(h,g,n,r,o)){f=!1;break}}return o.delete(e),o.delete(t),f}function Kr(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function Vr(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var Gr=1,Hr=2,Qr="[object Boolean]",Zr="[object Date]",Jr="[object Error]",Xr="[object Map]",ei="[object Number]",ti="[object RegExp]",ni="[object Set]",ri="[object String]",ii="[object Symbol]",oi="[object ArrayBuffer]",ai="[object DataView]",ci=$t?$t.prototype:void 0,li=ci?ci.valueOf:void 0;var si=1,ui=Object.prototype.hasOwnProperty;var pi=1,fi="[object Arguments]",di="[object Array]",hi="[object Object]",gi=Object.prototype.hasOwnProperty;function mi(e,t,n,r,i,o){var a=Xt(e),c=Xt(t),l=a?di:Pr(e),s=c?di:Pr(t),u=(l=l==fi?hi:l)==hi,p=(s=s==fi?hi:s)==hi,f=l==s;if(f&&Gn(e)){if(!Gn(t))return!1;a=!0,u=!1}if(f&&!u)return o||(o=new br),a||nr(e)?Wr(e,t,n,r,i,o):function(e,t,n,r,i,o,a){switch(n){case ai:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case oi:return!(e.byteLength!=t.byteLength||!o(new qr(e),new qr(t)));case Qr:case Zr:case ei:return Mn(+e,+t);case Jr:return e.name==t.name&&e.message==t.message;case ti:case ri:return e==t+"";case Xr:var c=Kr;case ni:var l=r&Gr;if(c||(c=Vr),e.size!=t.size&&!l)return!1;var s=a.get(e);if(s)return s==t;r|=Hr,a.set(e,t);var u=Wr(c(e),c(t),r,i,o,a);return a.delete(e),u;case ii:if(li)return li.call(e)==li.call(t)}return!1}(e,t,l,n,r,i,o);if(!(n&pi)){var d=u&&gi.call(e,"__wrapped__"),h=p&&gi.call(t,"__wrapped__");if(d||h){var g=d?e.value():e,m=h?t.value():t;return o||(o=new br),i(g,m,n,r,o)}}return!!f&&(o||(o=new br),function(e,t,n,r,i,o){var a=n&si,c=jr(e),l=c.length;if(l!=jr(t).length&&!a)return!1;for(var s=l;s--;){var u=c[s];if(!(a?u in t:ui.call(t,u)))return!1}var p=o.get(e),f=o.get(t);if(p&&f)return p==t&&f==e;var d=!0;o.set(e,t),o.set(t,e);for(var h=a;++s<l;){var g=e[u=c[s]],m=t[u];if(r)var y=a?r(m,g,u,t,e,o):r(g,m,u,e,t,o);if(!(void 0===y?g===m||i(g,m,n,r,o):y)){d=!1;break}h||(h="constructor"==u)}if(d&&!h){var v=e.constructor,b=t.constructor;v==b||!("constructor"in e)||!("constructor"in t)||"function"==typeof v&&v instanceof v&&"function"==typeof b&&b instanceof b||(d=!1)}return o.delete(e),o.delete(t),d}(e,t,n,r,i,o))}function yi(e,t,n,r,i){return e===t||(null==e||null==t||!Zt(e)&&!Zt(t)?e!=e&&t!=t:mi(e,t,n,r,yi,i))}function vi(e,t,n){for(var r=-1,i=null==e?0:e.length;++r<i;)if(n(t,e[r]))return!0;return!1}var bi=Math.min;function wi(e){return function(e){return Zt(e)&&Pn(e)}(e)?e:[]}var Ai=function(e,t){return Cn(function(e,t,n){return t=Ln(void 0===t?e.length-1:t,0),function(){for(var r=arguments,i=-1,o=Ln(r.length-t,0),a=Array(o);++i<o;)a[i]=r[t+i];i=-1;for(var c=Array(t+1);++i<t;)c[i]=r[i];return c[t]=n(a),function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}(e,this,c)}}(e,t,tn),e+"")}((function(e){var t=Jt(e,wi);return t.length&&t[0]===e[0]?function(e,t,n){for(var r=n?vi:Tn,i=e[0].length,o=e.length,a=o,c=Array(o),l=1/0,s=[];a--;){var u=e[a];a&&t&&(u=Jt(u,Qn(t))),l=bi(u.length,l),c[a]=!n&&(t||i>=120&&u.length>=120)?new Ur(a&&u):void 0}u=e[0];var p=-1,f=c[0];e:for(;++p<i&&s.length<l;){var d=u[p],h=t?t(d):d;if(d=n||0!==d?d:0,!(f?Br(f,h):r(s,h,n))){for(a=o;--a;){var g=c[a];if(!(g?Br(g,h):r(e[a],h,n)))continue e}f&&f.push(h),s.push(d)}}return s}(t):[]})),_i=Ai;function ji(e,t){return yi(e,t)}var ki=Or&&1/Vr(new Or([,-0]))[1]==1/0?function(e){return new Or(e)}:function(){},xi=200;function Oi(e){return e&&e.length?function(e,t,n){var r=-1,i=Tn,o=e.length,a=!0,c=[],l=c;if(n)a=!1,i=vi;else if(o>=xi){var s=t?null:ki(e);if(s)return Vr(s);a=!1,i=Br,l=new Ur}else l=t?[]:c;e:for(;++r<o;){var u=e[r],p=t?t(u):u;if(u=n||0!==u?u:0,a&&p==p){for(var f=l.length;f--;)if(l[f]===p)continue e;t&&l.push(p),c.push(u)}else i(l,p,n)||(l!==c&&l.push(p),c.push(u))}return c}(e):[]}const Si=async(e,t,{services:n,schema:r,database:i,getSchema:o})=>{const{SchemaService:a,RelationsService:c,ItemsService:l}=n,s=new a({accountability:{admin:!0}}),u={...e,diff:{...e.diff,data:null}};delete u.diff.data,await s.apply(u);const p=await o(),f=new c({schema:p,accountability:{admin:!0}}),d=await f.readAll();let h=Object.keys(e.diff.data);Array.isArray(t?.includeCollections)&&(h=_i(h,t?.includeCollections));const g=async(t,n)=>{const r=new l(t,{schema:p}),o=d.find((e=>e.related_collection===t&&e.meta.one_field)),a=p.collections[t]?.primary;o&&(n[o.meta?.one_field]=[]),console.log("addSingleItem",t,n[a]);if(!e.diff.data[t].find((e=>"D"===e.kind&&e.path[0]==n[a])))return void console.log("No more need to add");const c=d.filter((e=>e.collection===t&&e.related_collection===t));if(c.length)for(let i=0;i<c.length;i+=1){const o=c[i].field;if(null===n[o])continue;const a=c[i].schema.foreign_key_column;if(!(await r.readByQuery({filter:{[a]:{_eq:n[o]}}})).length){console.log("Found unexisting dependency",t,a,"=",n[o]);const r=e.diff.data[t].find((e=>"D"===e.kind&&e.lhs[a]===n[o]));if(!r)throw new Error("Can't find foreign item...");await g(t,r.lhs)}}await r.createOne(n,{emitEvents:!1}),"directus_users"===t&&await i(t).where(a,n[a]).update({password:n.password}),e.diff.data[t]=e.diff.data[t].filter((e=>"D"!==e.kind||"D"===e.kind&&e.path[0]!=n[a]))},m=async(t,n=[])=>{if(n.find((e=>ji(e,t))))console.log("[addData] Loop detected");else for(let r=0;r<t.length;r+=1){const i=t[r],o=d.filter((e=>e.collection===i&&e.related_collection!==i)).map((e=>e.related_collection));o.length&&await m(Oi(o),[...n,t]);const a=e.diff.data[i];if(!a)continue;const c=a.filter((e=>"D"===e.kind));if(!h.includes(i))return void console.log("[addData] Ignoring collection",i);for(let e=0;e<c.length;e+=1)await g(i,c[e].lhs)}},y=async(t,n=[])=>{if(n.find((e=>ji(e,t))))console.log("[deleteData] Loop detected");else for(let r=0;r<t.length;r+=1){const i=t[r],o=e.diff.data[i];if(!o)continue;const a=o.filter((e=>"N"===e.kind));if(!a.length)continue;const c=d.filter((e=>e.related_collection===i&&e.collection!==i)).map((e=>e.collection));c.length&&(await y(Oi(c),[...n,t]),await v(Oi(c)));const s=new l(i,{schema:p,accountability:{admin:!0}});if(!h.includes(i))return void console.log("[deleteData] Ignoring collection",i);const u=[];for(let e=0;e<a.length;e++)1===a[e].path.length?u.push(a[e]):console.log("[deleteData] ignoring deep change");await s.deleteMany(u.map((e=>e.path[0])),{emitEvents:!1}),e.diff.data[i]=e.diff.data[i].filter((e=>"N"!==e.kind))}},v=async t=>{for(let n=0;n<t.length;n+=1){const r=t[n],o=e.diff.data[r];if(!o)continue;const a=o.filter((e=>"E"===e.kind));if(!a.length)continue;const c=new l(r,{schema:p}),s=p.collections[r].primary;if(!h.includes(r))return void console.log("[updateData] Ignoring collection",r);for(let e=0;e<a.length;e+=1){const t=a[e].path[1];"directus_users"===r&&"password"===t?await i(r).where(s,a[e].path[0]).update({[t]:a[e].lhs}):await c.updateOne(a[e].path[0],{[t]:a[e].lhs},{emitEvents:!1})}e.diff.data[r]=e.diff.data[r].filter((e=>"E"!==e.kind))}};console.log(`Applying data for collections ${h.join(", ")}...`),await y(h),await m(h),await v(h);for(const e in p.collections){const t=p.collections[e];"AUTO_INCREMENT"===t.fields[t.primary].defaultValue&&await i.raw(`select setval('"${t.collection}_${t.primary}_seq"', max(${t.primary})) from "${t.collection}"`)}},Ci=async({schema:e,services:t,database:n})=>{const{SchemaService:r}=t,i=new r({accountability:{admin:!0}}),o=await i.snapshot();return o.data=await Dt({schema:e,services:t,database:n}),o},Ii="./snapshot/snapshot.yml";const Ti=[{name:"init",config:({init:t,embed:n},{services:r,database:i,getSchema:o})=>{"production"!==process.env.PHASE&&n("body",(()=>{let e="var(--foreground-subdued)";switch(process.env.PHASE){case"development":e="red";break;case"staging":e="orange"}return`\n<style>\n#directus .public-view .subtitle,\n#directus .project-info .descriptor {\n\tfont-size: 0;\n}\n#directus .public-view .subtitle:before,\n#directus .project-info .descriptor:before {\n\tcolor: ${e};\n\tcontent: '${process.env.PHASE} phase';\n\tfont-size: 1rem;\n\ttext-transform: capitalize;\n}\n</style>\n`})),t("app.before",(async({app:t})=>{try{t.locals.migrator={snapshotFile:Ii};const n=await o();if(e.existsSync(Ii)){let t=null;try{t=e.readFileSync(Ii),t=Et(t);for(const e in t.data)for(const n in t.data[e])for(const r in t.data[e][n])"object"==typeof t.data[e][n][r]&&null!==t.data[e][n][r]&&(t.data[e][n][r]=JSON.stringify(t.data[e][n][r]))}catch(e){throw e}const a=await zt(t,{services:r,database:i,schema:n});let c=null;"production"!==process.env.PHASE&&"staging"!==process.env.PHASE||(c={includeCollections:["directus_roles","directus_permissions","directus_presets","directus_dashboards","directus_panels","directus_flows","directus_operations"]}),await Si(a,c,{services:r,schema:n,database:i,getSchema:o}),console.log("Snapshot applied")}else{console.log("Snaphot file not found. Creating a new one...");const t=await Ci({schema:n,services:r,database:i});e.writeFileSync(Ii,Mt(t))}}catch(e){console.log("Snapshot applying error:"),console.log(e),process.exit(1)}}))}}],Fi=[{name:"migrator-api",config:(t,{services:n,getSchema:r,database:i})=>{t.get("/diff",(async(t,r,o)=>{let a=null;try{a=e.readFileSync(t.app.locals.migrator.snapshotFile),a=Et(a)}catch(e){o(e)}const c=await zt(a,{services:n,schema:t.schema,database:i,force:"force"in t.query});r.send(c)})),t.get("/generate",(async(t,r,o)=>{const a=t.app.locals.migrator.snapshotFile,c=await Ci({schema:t.schema,services:n,database:i});e.existsSync(a)&&e.unlinkSync(a),e.writeFileSync(a,Mt(c)),r.send(c)})),t.get("/apply",(async(t,o,a)=>{let c=null;try{c=e.readFileSync(t.app.locals.migrator.snapshotFile),c=Et(c)}catch(e){a(e)}const l=await zt(c,{services:n,schema:t.schema,database:i,force:"force"in t.query});await Si(l,null,{services:n,schema:t.schema,database:i,getSchema:r}),o.send("OK")}))}}],Ni=[];export{Fi as endpoints,Ti as hooks,Ni as operations};
